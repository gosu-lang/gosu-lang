name: Release gosu to mvn Central

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.18.7)'
        required: true
        type: string

jobs:
  prepare-release:
   # needs: build-test
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for creating tags and pushing commits
    outputs:
      can-publish: ${{ steps.check-perms.outputs.can-publish }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure release branch
        run: |
          if [[ "${GITHUB_REF_NAME}" != rel/* ]]; then
            echo "‚ùå Manual runs allowed only on rel/* branches"
            exit 1
          fi

      - name: Set up Java (Amazon Corretto 11)
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '11'
          cache: 'maven'

      - name: Check repository permissions
        id: check-perms
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: 'gosu-lang',
                repo: 'gosu-lang',
                username: context.actor
              });
              console.log(`User ${context.actor} repository permission: ${permission.data.permission}`);
              const allowedRoles = ['admin', 'maintain'];
              const hasPermission = allowedRoles.includes(permission.data.permission);
              console.log(`Permission check result: ${hasPermission}`);
              core.setOutput('can-publish', hasPermission.toString());
              return hasPermission;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              core.setOutput('can-publish', 'false');
              return false;
            }

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          # Strict SemVer.org expression (POSIX ERE compliant: no \d, no non-capturing groups)
          REGEX='^(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-((0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9][0-9]*|[0-9]*[a-zA-Z-][0-9a-zA-Z-]*))*))?(\+([0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*))?$'
          if [[ ! "$VERSION" =~ $REGEX ]]; then
            echo "Error: Version '$VERSION' does not match the standard SemVer format."
            exit 1
          fi
          echo "Version $VERSION is valid"

      - name: Configure Git
        if: steps.check-perms.outputs.can-publish == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: prepare release
        if: steps.check-perms.outputs.can-publish == 'true'
        run: mvn release:prepare -B -DdevelopmentVersion=1-X-SNAPSHOT -DreleaseVersion=${{ inputs.version }}

  release-gosu:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java (Amazon Corretto 11)
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '11'
          cache: 'maven'

      - name: release Gosu
        if: needs.prepare-release.outputs.can-publish == 'true'
        run: mvn release:perform -B -s $GITHUB_WORKSPACE/settings.xml -Prelease