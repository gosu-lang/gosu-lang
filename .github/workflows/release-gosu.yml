name: Release gosu to mvn Central

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.18.7)'
        required: true
        type: string

jobs:
  prepare-release:
   # needs: build-test
    runs-on: ubuntu-latest
    outputs:
      can-publish: ${{ steps.check-perms.outputs.can-publish }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Ensure release branch
        run: |
          if [[ "${GITHUB_REF_NAME}" != rel/* ]]; then
            echo "‚ùå Manual runs allowed only on rel/* branches"
            exit 1
          fi

      - name: Set up Java (Amazon Corretto 11)
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '11'
          cache: 'maven'

      - name: Check repository permissions
        id: check-perms
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: 'gosu-lang',
                repo: 'gosu-lang',
                username: context.actor
              });
              console.log(`User ${context.actor} repository permission: ${permission.data.permission}`);
              const allowedRoles = ['admin', 'maintain'];
              const hasPermission = allowedRoles.includes(permission.data.permission);
              console.log(`Permission check result: ${hasPermission}`);
              core.setOutput('can-publish', hasPermission.toString());
              return hasPermission;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              core.setOutput('can-publish', 'false');
              return false;
            }

      - name: Validate version format
        run: |
          if [[ ! "${{ inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9]+)?$ ]]; then
            echo "Error: Version must follow semantic versioning (e.g., 1.2.3 or 1.2.3-RC1)"
            exit 1
          fi
          echo "Version ${{ inputs.version }} is valid"

      - name: prepare release
        if: steps.check-perms.outputs.can-publish == 'true'
        run: mvn release:prepare -B -DdevelopmentVersion=1-X-SNAPSHOT -DreleaseVersion=${{ inputs.version }}

  release-gosu:
    needs: prepare-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java (Amazon Corretto 11)
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '11'
          cache: 'maven'

      - name: release Gosu
        if: needs.prepare-release.outputs.can-publish == 'true'
        run: mvn release:perform -B -s $GITHUB_WORKSPACE/settings.xml -Prelease