name: Publish-Snapshots to mvn Central

on:
  workflow_dispatch:

jobs:
  publish-snapshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Ensure release branch
        run: |
          if [[ "${GITHUB_REF_NAME}" != rel/* ]]; then
            echo "âŒ Manual runs allowed only on rel/* branches"
            exit 1
          fi

      - name: Set up Java (Amazon Corretto 11)
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '11'
          cache: 'maven'

      - name: Check repository permissions
        id: check-perms
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const permission = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: 'gosu-lang',
                repo: 'gosu-lang',
                username: context.actor
              });
              console.log(`User ${context.actor} repository permission: ${permission.data.permission}`);
              const allowedRoles = ['admin', 'maintain'];
              const hasPermission = allowedRoles.includes(permission.data.permission);
              console.log(`Permission check result: ${hasPermission}`);
              core.setOutput('can-publish', hasPermission.toString());
              return hasPermission;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              core.setOutput('can-publish', 'false');
              return false;
            }

      - name: Publish snapshot to Maven Central
        if: steps.check-perms.outputs.can-publish == 'true'
        run: mvn deploy -Pcentral -Dmaven.test.skip=true -s $GITHUB_WORKSPACE/settings.xml -B
        env:
          SNAPSHOT_USER_CENTRAL: ${{ secrets.SNAPSHOT_USER_CENTRAL }}
          SNAPSHOT_PASS_CENTRAL: ${{ secrets.SNAPSHOT_PASS_CENTRAL }}

      - name: Report published version
        if: steps.check-perms.outputs.can-publish == 'true'
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "## ðŸ“¦ Snapshot Published" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** Maven Central Snapshots" >> $GITHUB_STEP_SUMMARY